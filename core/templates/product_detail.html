<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جزئیات محصول: {{ product.name }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Vazir Font -->
    <link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Vazir', sans-serif;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .stats-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .list-group-item {
            border: none;
            padding: 15px;
            background-color: #fff;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .btn-primary, .btn-secondary, .btn-success, .btn-info {
            border-radius: 10px;
        }
        .product-image {
            max-width: 200px;
            border-radius: 10px;
        }
        #ai-loading {
            display: none;
            color: #007bff;
        }
        #chat-response {
            margin-top: 10px;
        }
        @media (max-width: 768px) {
            .stats-box {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
<div class="container py-5">
    <h1 class="text-center mb-4">جزئیات محصول: {{ product.name }}</h1>

    <!-- اطلاعات محصول -->
    <div class="card mb-4">
        <div class="card-body text-center">
            {% if product.image_url %}
            <img src="{{ product.image_url }}" alt="{{ product.name }}" class="product-image mb-3">
            {% endif %}
            <h4>{{ product.name }}</h4>
            <p class="text-muted">دسته‌بندی: {{ product.category|default:"نامشخص" }}</p>
            <p>قیمت: {{ product.price|default:"نامشخص" }} تومان</p>
            <p>موجودی: {{ product.stock|default:"نامشخص" }}</p>
            <p>تخفیف: {{ product.discount|default:"0" }}%</p>
        </div>
    </div>

    <!-- آمار محصول -->
    <h2 class="mb-3">آمار 30 روز گذشته</h2>
    <div class="row g-4 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="stats-box">
                <h5>بازدید</h5>
                <p class="fs-3 text-primary">{{ views_30_days }}</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-box">
                <h5>افزودن به سبد</h5>
                <p class="fs-3 text-success">{{ carts_30_days }}</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-box">
                <h5>خرید نهایی</h5>
                <p class="fs-3 text-danger">{{ purchases_30_days }}</p>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="stats-box">
                <h5>نرخ تبدیل</h5>
                <p class="fs-3 text-info">{{ conversion_rate }}%</p>
            </div>
        </div>
    </div>

    <!-- نمودار روند -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">روند فعالیت محصول</h5>
        </div>
        <div class="card-body">
            <canvas id="productChart" height="100"></canvas>
        </div>
    </div>

    <!-- پیشنهادات -->
    <h2 class="mb-3">پیشنهادات برای افزایش فروش</h2>
    <div class="card mb-4">
        <div class="card-body">
            <button id="request-ai-btn" class="btn btn-success mb-3">درخواست پیشنهاد از هوش مصنوعی</button>
            <a href="{% url 'core:product_abandonment' product.id %}" class="btn btn-info mb-3">تحلیل ترک سبد خرید</a>
            <a href="{% url 'core:competitor_comparison' product.id %}" class="btn btn-info mb-3">مقایسه با رقبا</a>
            <a href="{% url 'core:product_report_pdf' product.id %}" class="btn btn-primary mt-3">دانلود گزارش PDF</a>
            <span id="ai-loading">در حال دریافت پیشنهادات...</span>
            <ul id="recommendations-list" class="list-group">
                {% for rec in recommendations %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ rec.text }}
                    <div>
                        {% if rec.confidence_score %}
                        <span class="badge bg-primary rounded-pill">امتیاز: {{ rec.confidence_score }}</span>
                        {% endif %}
                        {% if rec.reason == 'AI_GENERATED' %}
                        <span class="badge bg-success rounded-pill">هوش مصنوعی</span>
                        {% elif rec.reason == 'DYNAMIC_PRICING' %}
                        <span class="badge bg-warning rounded-pill">پیشنهاد قیمت</span>
                        {% else %}
                        <span class="badge bg-info rounded-pill">تحلیل سیستم</span>
                        {% endif %}
                    </div>
                </li>
                {% empty %}
                <li class="list-group-item text-center">پیشنهادی موجود نیست</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- چت با هوش مصنوعی -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">چت با هوش مصنوعی</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <input type="text" id="chat-question" class="form-control"
                       placeholder="سوال خود را بپرسید (مثلاً: چطور فروش این محصول را افزایش دهم؟)">
                <button id="chat-submit" class="btn btn-success mt-2">ارسال سوال</button>
            </div>
            <div id="chat-response" class="alert alert-info" style="display: none;"></div>
        </div>
    </div>

    <!-- دکمه بازگشت -->
    <a href="{% url 'core:dashboard_overview' %}" class="btn btn-secondary mt-4">بازگشت به داشبورد</a>
</div>

<!-- Bootstrap JS and Chart.js Script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // نمودار روند
    const ctx = document.getElementById('productChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|safe }},
            datasets: [
                {
                    label: 'بازدید',
                    data: {{ chart_views|safe }},
                    borderColor: '#007bff',
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'افزودن به سبد',
                    data: {{ chart_carts|safe }},
                    borderColor: '#28a745',
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'خرید',
                    data: {{ chart_purchases|safe }},
                    borderColor: '#dc3545',
                    fill: false,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'تعداد' }
                },
                x: {
                    title: { display: true, text: 'روز' }
                }
            },
            plugins: {
                legend: { position: 'top' }
            }
        }
    });

    // درخواست پیشنهادات هوش مصنوعی
    document.getElementById('request-ai-btn').addEventListener('click', function() {
        const loading = document.getElementById('ai-loading');
        const list = document.getElementById('recommendations-list');
        loading.style.display = 'inline-block';
        this.disabled = true;

        fetch("{% url 'core:request_ai_recommendation' product.id %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'

            }
        })
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            this.disabled = false;

            // پاک کردن پیشنهادات قبلی هوش مصنوعی
            list.querySelectorAll('.list-group-item').forEach(item => {
                if (item.querySelector('.bg-success')) {
                    item.remove();
                }
            });

            // اضافه کردن پیشنهادات جدید
            data.recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    ${rec.text}
                    <div>
                        <span class="badge bg-primary rounded-pill">امتیاز: ${rec.confidence_score}</span>
                        <span class="badge bg-success rounded-pill">هوش مصنوعی</span>
                    </div>
                `;
                list.prepend(li);
            });

            // اگر هیچ پیشنهادی نبود
            if (!data.recommendations.length && !list.querySelector('.list-group-item')) {
                list.innerHTML = '<li class="list-group-item text-center">پیشنهادی موجود نیست</li>';
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            this.disabled = false;
            console.error('Error:', error);
            alert('خطا در دریافت پیشنهادات. لطفاً دوباره تلاش کنید.');
        });
    });

    // چت با هوش مصنوعی
    document.getElementById('chat-submit').addEventListener('click', function() {
        const question = document.getElementById('chat-question').value;
        const responseDiv = document.getElementById('chat-response');
        if (!question) {
            responseDiv.textContent = 'لطفاً یک سوال وارد کنید.';
            responseDiv.style.display = 'block';
            return;
        }
        fetch("{% url 'core:ai_chat_recommendation' product.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            responseDiv.textContent = data.answer || data.error;
            responseDiv.style.display = 'block';
        })
        .catch(error => {
            responseDiv.textContent = 'خطا در ارتباط با سرور.';
            responseDiv.style.display = 'block';
        });
    });
</script>
</body>
</html>