<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد جامع فروش</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { background-color: #f8f9fa; font-family: 'Vazirmatn', sans-serif; }
        .card { border: none; border-radius: 1rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,.05); }
        .card-header { background: transparent; border-bottom: 1px solid #eee; font-weight: 700; padding: 1rem 1.5rem; }
        .stats-box { background-color: #fff; padding: 20px; border-radius: 1rem; text-align: center; box-shadow: 0 0.5rem 1rem rgba(0,0,0,.05); margin-bottom: 1rem; }
        .list-group-item { border: none; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.75rem; background-color: #fff; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body>
<div class="container py-5">
    <h1 class="text-center mb-5">داشبورد جامع فروش</h1>

    <!-- فیلتر تاریخ -->
    <div class="card mb-4">
        <div class="card-body p-4">
            <form id="date-filter-form" method="get" class="row g-3 align-items-center">
                <div class="col-md-5"><label class="form-label">از تاریخ:</label><input type="date" name="start_date" value="{{ start_date_str }}" class="form-control"></div>
                <div class="col-md-5"><label class="form-label">تا تاریخ:</label><input type="date" name="end_date" value="{{ end_date_str }}" class="form-control"></div>
                <div class="col-md-2 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100">اعمال فیلتر</button></div>
            </form>
        </div>
    </div>

    <!-- آمار کلی -->
    <div class="row g-3 mb-4">
        <div class="col-md-3 col-6"><div class="stats-box"><h5>بازدید کل</h5><p class="fs-3 text-primary mb-0">{{ total_views }}</p></div></div>
        <div class="col-md-3 col-6"><div class="stats-box"><h5>سبد خرید</h5><p class="fs-3 text-success mb-0">{{ total_carts }}</p></div></div>
        <div class="col-md-3 col-6"><div class="stats-box"><h5>خرید نهایی</h5><p class="fs-3 text-danger mb-0">{{ total_purchases }}</p></div></div>
        <div class="col-md-3 col-6"><div class="stats-box"><h5>نرخ تبدیل کل</h5><p class="fs-3 text-info mb-0">{{ overall_conversion }}%</p></div></div>
    </div>

    <!-- نمودار و قیف فروش -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header">روند فعالیت‌ها</div>
                <div class="card-body p-4"><canvas id="overviewChart"></canvas></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">تحلیل قیف فروش</div>
                <div class="card-body p-4 d-flex flex-column justify-content-center">
                    <h6 class="small">بازدید<span class="float-end text-muted">{{ funnel_data.views }} کاربر</span></h6>
                    <div class="progress mb-3" style="height: 20px;"><div class="progress-bar bg-primary" style="width: 100%">100%</div></div>
                    <h6 class="small">افزودن به سبد<span class="float-end text-muted">{{ funnel_data.carts }} کاربر</span></h6>
                    <div class="progress mb-3" style="height: 20px;"><div class="progress-bar bg-success" style="width: {{ funnel_data.view_to_cart_rate|floatformat:1 }}%">{{ funnel_data.view_to_cart_rate|floatformat:1 }}%</div></div>
                    <h6 class="small">خرید نهایی<span class="float-end text-muted">{{ funnel_data.purchases }} کاربر</span></h6>
                    <div class="progress" style="height: 20px;"><div class="progress-bar bg-danger" style="width: {{ funnel_data.overall_conversion_rate|floatformat:1 }}%">{{ funnel_data.overall_conversion_rate|floatformat:1 }}%</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- تحلیل‌های پیشرفته -->
    <div class="row g-4 mb-4">
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header">تحلیل سبد خرید (چه محصولاتی با هم خریداری می‌شوند؟)</div>
                <div class="card-body p-4">
                    {% if market_basket_rules %}
                        <ul class="list-group list-group-flush">
                        {% for row in market_basket_rules %}
                            <li class="list-group-item"><i class="fas fa-shopping-basket text-primary me-2"></i>اگر مشتری <b>{{ row.antecedents }}</b> را بخرد، به احتمال <b>{{ row.confidence|floatformat:0 }}%</b>، محصول <b>{{ row.consequents }}</b> را نیز خواهد خرید.</li>
                        {% endfor %}
                        </ul>
                    {% else %}<div class="alert alert-info mb-0">{{ market_basket_message }}</div>{% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header">بخش‌بندی مشتریان</div>
                <div class="card-body p-4">
                    <p class="mb-2"><strong><i class="fas fa-gem text-success me-2"></i>مشتریان باارزش:</strong> {% for item in customer_segments.high_value %}<span class="badge bg-light text-dark m-1">{{ item.customer__identifier }}</span>{% empty %}یافت نشد.{% endfor %}</p>
                    <p class="mb-2"><strong><i class="fas fa-star text-warning me-2"></i>مشتریان وفادار:</strong> {% for item in customer_segments.loyal %}<span class="badge bg-light text-dark m-1">{{ item.customer__identifier }}</span>{% empty %}یافت نشد.{% endfor %}</p>
                    <p class="mb-0"><strong><i class="fas fa-eye text-info me-2"></i>خریداران پنجره‌ای:</strong> {% for item in customer_segments.window_shoppers %}<span class="badge bg-light text-dark m-1">{{ item.customer__identifier }}</span>{% empty %}یافت نشد.{% endfor %}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- پیش‌بینی و پیشنهادات -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">پیش‌بینی فروش ۳۰ روز آینده</div>
                <div class="card-body p-4">
                    {% if sales_forecast %}<h6 class="text-primary mb-3">برای پرفروش‌ترین محصول: <b>{{ forecast_product_name }}</b></h6><div class="table-responsive" style="max-height: 250px;"><table class="table table-sm table-borderless">{% for date, count in sales_forecast.items %}<tr><td>{{ date }}</td><td><span class="badge bg-light text-primary">پیش‌بینی: {{ count }} عدد فروش</span></td></tr>{% endfor %}</table></div>{% else %}<div class="alert alert-info mb-0">{{ forecast_message }}</div>{% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
             <div class="card">
                <div class="card-header">پیشنهادات هوشمند</div>
                <div class="card-body p-4"><ul class="list-group list-group-flush">{% for rec in recommendations %}<li class="list-group-item">{{ rec.text }}{% if rec.confidence_score %}<span class="badge bg-primary rounded-pill float-end">اطمینان: {{ rec.confidence_score|floatformat:0 }}%</span>{% endif %}</li>{% empty %}<li class="list-group-item text-center text-muted">پیشنهادی موجود نیست</li>{% endfor %}</ul></div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('overviewChart').getContext('2d');
    let overviewChart;

    function renderChart(chartData) {
        if (overviewChart) {
            overviewChart.destroy();
        }
        overviewChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [
                    { label: 'بازدید', data: chartData.views, borderColor: '#0d6efd', tension: 0.3, fill: false },
                    { label: 'افزودن به سبد', data: chartData.carts, borderColor: '#198754', tension: 0.3, fill: false },
                    { label: 'خرید', data: chartData.purchases, borderColor: '#dc3545', tension: 0.3, fill: false }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    function fetchChartData() {
        const startDate = document.querySelector('input[name="start_date"]').value;
        const endDate = document.querySelector('input[name="end_date"]').value;
        // از تگ url جنگو برای ساختن آدرس داینامیک استفاده می‌کنیم
        const url = `{% url 'core:daily_events_chart_api' %}?start_date=${startDate}&end_date=${endDate}`;

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('پاسخ شبکه ناموفق بود');
                return response.json();
            })
            .then(data => {
                renderChart(data);
            })
            .catch(error => console.error('خطا در دریافت داده‌های نمودار:', error));
    }

    // فراخوانی تابع در زمان بارگذاری صفحه
    fetchChartData();

    // اگر فرم فیلتر تاریخ تغییر کرد، دوباره داده‌ها را واکشی کن
    document.getElementById('date-filter-form').addEventListener('submit', function(e) {
        e.preventDefault(); // جلوگیری از رفرش کامل صفحه
        fetchChartData();
    });
});
</script>
</body>
</html>