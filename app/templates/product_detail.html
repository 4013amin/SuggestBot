<!-- templates/app/product_detail.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }}</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
        .product-main { text-align: center; margin-bottom: 50px; }
        .price { color: #28a745; font-size: 1.5em; font-weight: bold; }
        .description { color: #555; margin-top: 20px; }
        .recommendations-container { margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px; }
        .recommendations-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .rec-card { border: 1px solid #ddd; padding: 10px; background-color: #f9f9f9; text-align: center; }
        .rec-price { color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>
    <div class="product-main">
        <h1>{{ product.name }}</h1>
        <p class="price">{{ product.price|floatformat:0 }} تومان</p>
        <p class="description">{{ product.description }}</p>
    </div>

    <div class="recommendations-container">
        <h2>محصولات پیشنهادی برای شما</h2>
        <div id="recommendations-placeholder" style="min-height: 150px; position: relative;">
            <p class="loading" style="text-align: center; color: #777;">در حال بارگذاری پیشنهادها...</p>
        </div>
    </div>

    <!-- تمام منطق جاوااسکریپت اینجا قرار می‌گیرد -->
    <script>
        // === بخش ۱: اسکریپت ردیاب (Tracker) ===
        (function() {
            const API_BASE_URL = window.location.origin; // آدرس API همان آدرس سایت فعلی است

            function getSessionId() {
                let sessionId = document.cookie.replace(/(?:(?:^|.*;\s*)suggestbot_session\s*\=\s*([^;]*).*$)|^.*$/, "$1");
                if (!sessionId) {
                    sessionId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    document.cookie = `suggestbot_session=${sessionId};path=/`;
                }
                return sessionId;
            }

            async function trackEvent(eventType, data = {}) {
                const payload = {
                    session_id: getSessionId(),
                    event_type: eventType,
                    ...data
                };
                try {
                    await fetch(`${API_BASE_URL}/api/track-event/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    console.log('Event tracked:', payload);
                } catch (error) {
                    console.error('Tracker failed:', error);
                }
            }

            // ثبت رویداد مشاهده این محصول
            trackEvent('VIEW', { product_source_id: '{{ product.source_id }}' });
        })();


        // === بخش ۲: اسکریپت نمایش پیشنهادها ===
        document.addEventListener('DOMContentLoaded', function() {
            const placeholder = document.getElementById('recommendations-placeholder');
            const currentProductId = '{{ product.source_id }}';
            const apiBaseUrl = window.location.origin;

            fetch(`${apiBaseUrl}/api/recommendations/product/${currentProductId}/`)
                .then(response => response.json())
                .then(products => {
                    placeholder.innerHTML = ''; // پاک کردن پیام لودینگ
                    if (products.length > 0) {
                        const grid = document.createElement('div');
                        grid.className = 'recommendations-grid';
                        products.forEach(product => {
                            const card = document.createElement('div');
                            card.className = 'rec-card';
                            card.innerHTML = `
                                <h3>${product.name}</h3>
                                <p class="rec-price">${parseFloat(product.price).toLocaleString('fa-IR')} تومان</p>
                            `;
                            grid.appendChild(card);
                        });
                        placeholder.appendChild(grid);
                    } else {
                        placeholder.innerHTML = '<p style="text-align: center; color: #777;">پیشنهادی یافت نشد.</p>';
                    }
                })
                .catch(error => {
                    console.error('Recommendations failed:', error);
                    placeholder.innerHTML = '<p style="text-align: center; color: #cc0000;">خطا در دریافت پیشنهادها.</p>';
                });
        });
    </script>
</body>
</html>